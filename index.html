<!DOCTYPE html>
<html>
<head>
    <title>AI Smart Soil Analysis</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        .box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        h2 { color: #2e7d32; }
        #result { font-weight: bold; font-size: 1.2em; color: #d32f2f; margin-top: 10px;}
        button { background: #2e7d32; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; border-radius: 5px;}
        button:hover { background: #1b5e20; }
        .data-item { margin-bottom: 5px; }
    </style>
</head>
<body onload="fetchAndAnalyze()"> 
    
    <div class="box">
        <h2>üå± AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å IoT...</p>
        
        <div id="sensor-display">
            ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <br>
        <button onclick="fetchAndAnalyze()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
        
        <p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</p>
        <div id="result">-</div>
    </div>

    <script>
        // *** 1. ‡πÉ‡∏™‡πà CSV URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà Google Sheet ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ' ' ‡∏•‡πâ‡∏≠‡∏°‡∏£‡∏≠‡∏ö) ***
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSLIE-xwPr0kFUfTKWatQMG6YXAswXoXnXn5jtS9A9T1XlZPMRHhxjok2BkTQAWbX2CuvNhrW9Yimn/pub?output=csv';

        // 2. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏à‡∏≤‡∏Å Colab: ['Durian' 'Rice' 'Rubber'])
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 0: Durian, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1: Rice, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2: Rubber
        const cropNames = ['Durian', 'Rice', 'Rubber'];

        // ------------------------------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Python ‡πÇ‡∏î‡∏¢ m2cgen)
        // ------------------------------------------------------------------------
        function score(input) {
            var var0;
            if (input[3] <= 92.5) {
                if (input[5] <= 36.0) {
                    var0 = [0.0, 0.0, 1.0];
                } else {
                    var0 = [0.0, 1.0, 0.0];
                }
            } else {
                var0 = [1.0, 0.0, 0.0];
            }
            var var1;
            if (input[7] <= 25.5) {
                var1 = [0.0, 1.0, 0.0];
            } else {
                if (input[2] <= 6000.0) {
                    var1 = [1.0, 0.0, 0.0];
                } else {
                    var1 = [0.0, 0.0, 1.0];
                }
            }
            var var2;
            if (input[7] <= 26.0) {
                var2 = [0.0, 1.0, 0.0];
            } else {
                if (input[3] <= 55.0) {
                    var2 = [0.0, 0.0, 1.0];
                } else {
                    var2 = [1.0, 0.0, 0.0];
                }
            }
            var var3;
            if (input[5] <= 35.0) {
                var3 = [0.0, 0.0, 1.0];
            } else {
                if (input[8] <= 31.0) {
                    var3 = [0.0, 1.0, 0.0];
                } else {
                    var3 = [1.0, 0.0, 0.0];
                }
            }
            var var4;
            if (input[8] <= 31.5) {
                var4 = [0.0, 1.0, 0.0];
            } else {
                if (input[8] <= 34.0) {
                    var4 = [1.0, 0.0, 0.0];
                } else {
                    var4 = [0.0, 0.0, 1.0];
                }
            }
            var var5;
            if (input[2] <= 4750.0) {
                var5 = [1.0, 0.0, 0.0];
            } else {
                if (input[5] <= 36.0) {
                    var5 = [0.0, 0.0, 1.0];
                } else {
                    var5 = [0.0, 1.0, 0.0];
                }
            }
            var var6;
            if (input[5] <= 71.0) {
                if (input[5] <= 33.5) {
                    var6 = [0.0, 0.0, 1.0];
                } else {
                    var6 = [0.0, 1.0, 0.0];
                }
            } else {
                var6 = [1.0, 0.0, 0.0];
            }
            var var7;
            if (input[0] <= 77.5) {
                if (input[3] <= 55.0) {
                    var7 = [0.0, 0.0, 1.0];
                } else {
                    var7 = [1.0, 0.0, 0.0];
                }
            } else {
                var7 = [0.0, 1.0, 0.0];
            }
            var var8;
            if (input[2] <= 7000.0) {
                if (input[5] <= 70.0) {
                    var8 = [0.0, 1.0, 0.0];
                } else {
                    var8 = [1.0, 0.0, 0.0];
                }
            } else {
                var8 = [0.0, 0.0, 1.0];
            }
            var var9;
            if (input[6] <= 5.799999952316284) {
                var9 = [0.0, 0.0, 1.0];
            } else {
                if (input[5] <= 75.0) {
                    var9 = [0.0, 1.0, 0.0];
                } else {
                    var9 = [1.0, 0.0, 0.0];
                }
            }
            return mulVectorNumber(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(var0, var1), var2), var3), var4), var5), var6), var7), var8), var9), 0.1);
        }
        function addVectors(v1, v2) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] + v2[i];
            }
            return result;
        }
        function mulVectorNumber(v1, num) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] * num;
            }
            return result;
        }

        // ------------------------------------------------------------------------
        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        // ------------------------------------------------------------------------
        async function fetchAndAnalyze() {
    document.getElementById("result").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
    document.getElementById("sensor-display").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...";

    try {
        const response = await fetch(CSV_URL); 
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        
        // ‡πÅ‡∏õ‡∏•‡∏á CSV ‡πÄ‡∏õ‡πá‡∏ô Array of Rows
        const rows = csvText.trim().split('\n');
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á: ‡∏•‡∏ö header (rows[0]) ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ rows.length - 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        let latestRow = null;
        for (let i = rows.length - 1; i >= 1; i--) { // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            const tempValues = rows[i].split(',').map(v => v.trim());
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô columns ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 9 columns ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
            if (tempValues.filter(v => v !== '').length > 5) {
                latestRow = rows[i];
                break;
            }
        }

        if (!latestRow) {
            document.getElementById("result").innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô Google Sheets";
            document.getElementById("sensor-display").innerHTML = "‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ IoT ‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sheet ‡πÅ‡∏•‡πâ‡∏ß";
            return;
        }

        const values = latestRow.split(',');

        // *** ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ .trim() ‡∏Å‡πà‡∏≠‡∏ô parseFloat() ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö Index ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤:
        // values[0]: Timestamp, values[1]: AirTemp, values[2]: AirHum, values[3]: SoilTemp, values[4]: Soil%, values[5]: SoilStatus, values[6]: Light, values[7]: pH, values[8]: N, values[9]: P, values[10]: K
        
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà AI ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:
        // Hum_Soil(0), Hum_Air(1), Light(2), N(3), P(4), K(5), pH(6), Temp_Soil(7), Temp_Air(8)
        
        const currentData = [
            parseFloat(values[4].trim()), // 0. Hum_Soil (‡πÉ‡∏ä‡πâ Soil% ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 4)
            parseFloat(values[2].trim()), // 1. Hum_Air (‡πÉ‡∏ä‡πâ AirHum ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 2)
            parseFloat(values[6].trim()), // 2. Light (‡πÉ‡∏ä‡πâ Light ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 6)
            parseFloat(values[8].trim()), // 3. Nitrogen (N) (‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 8)
            parseFloat(values[9].trim()), // 4. Phosphorus (P) (‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 9)
            parseFloat(values[10].trim()),// 5. Potassium (K) (‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 10)
            parseFloat(values[7].trim()), // 6. pH (‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 7)
            parseFloat(values[3].trim()), // 7. Temp_Soil (‡πÉ‡∏ä‡πâ SoilTemp ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 3)
            parseFloat(values[1].trim()) // 8. Temp_Air (‡πÉ‡∏ä‡πâ AirTemp ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Index 1)
        ];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏õ‡πá‡∏ô NaN ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô NaN ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô CSV ‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏ú‡∏¥‡∏î)
        if (currentData.some(isNaN)) {
             document.getElementById("result").innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (NaN) ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
             console.error("Sensor data contains NaN:", currentData);
             return;
        }

        // --- ‡πÉ‡∏´‡πâ AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ---
        let probabilities = score(currentData);
        
        // ‡∏´‡∏≤‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        let maxIndex = probabilities.indexOf(Math.max(...probabilities));
        let resultCrop = cropNames[maxIndex]; 

        // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
        
        // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ Sensor ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById("sensor-display").innerHTML = `
            <div class="data-item"><strong>NPK:</strong> ${currentData[3].toFixed(1)}-${currentData[4].toFixed(1)}-${currentData[5].toFixed(1)} | <strong>pH:</strong> ${currentData[6].toFixed(2)}</div>
            <div class="data-item"><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[0].toFixed(1)}% / ${currentData[1].toFixed(1)}%</div>
            <div class="data-item"><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[7].toFixed(1)}¬∞C / ${currentData[8].toFixed(1)}¬∞C | <strong>‡πÅ‡∏™‡∏á:</strong> ${currentData[2].toFixed(0)} LUX</div>
        `;

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
        document.getElementById("result").innerText = "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö: " + resultCrop;
        
    } catch (error) {
        console.error("Error fetching or processing data:", error);
        document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSV URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish to web)";
    }
}
    </script>
</body>
</html>
