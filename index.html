<!DOCTYPE html>
<html>
<head>
    <title>AI Smart Soil Analysis</title>
    <style>
        /* ... (CSS Styles ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°) ... */
    </style>
</head>
<body onload="fetchAndAnalyze()"> 
    
    <div class="box">
        <h2>üå± AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å IoT...</p>
        
        <div id="sensor-display">
            ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <br>
        <button onclick="fetchAndAnalyze()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
        
        <p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</p>
        <div id="result">-</div>
    </div>

    <script>
        // 1. ‡πÉ‡∏™‡πà CSV URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà Google Sheet ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSLIE-xwPr0kFUfTKWatQMG6YXAswXoXnXn5jtS9A9T1XlZPMRHhxjok2BkTQAWbX2CuvNhrW9Yimn/pub?output=csv';

        // 2. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏à‡∏≤‡∏Å Colab)
        const cropNames = ['Durian', 'Rice', 'Rubber'];

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÇ‡∏Ñ‡πâ‡∏î score, addVectors, mulVectorNumber ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°)
        // ------------------------------------------------------------------------
        function score(input) {
            var var0;
            if (input[3] <= 92.5) {
                if (input[5] <= 36.0) {
                    var0 = [0.0, 0.0, 1.0];
                } else {
                    var0 = [0.0, 1.0, 0.0];
                }
            } else {
                var0 = [1.0, 0.0, 0.0];
            }
            var var1;
            if (input[7] <= 25.5) {
                var1 = [0.0, 1.0, 0.0];
            } else {
                if (input[2] <= 6000.0) {
                    var1 = [1.0, 0.0, 0.0];
                } else {
                    var1 = [0.0, 0.0, 1.0];
                }
            }
            var var2;
            if (input[7] <= 26.0) {
                var2 = [0.0, 1.0, 0.0];
            } else {
                if (input[3] <= 55.0) {
                    var2 = [0.0, 0.0, 1.0];
                } else {
                    var2 = [1.0, 0.0, 0.0];
                }
            }
            var var3;
            if (input[5] <= 35.0) {
                var3 = [0.0, 0.0, 1.0];
            } else {
                if (input[8] <= 31.0) {
                    var3 = [0.0, 1.0, 0.0];
                } else {
                    var3 = [1.0, 0.0, 0.0];
                }
            }
            var var4;
            if (input[8] <= 31.5) {
                var4 = [0.0, 1.0, 0.0];
            } else {
                if (input[8] <= 34.0) {
                    var4 = [1.0, 0.0, 0.0];
                } else {
                    var4 = [0.0, 0.0, 1.0];
                }
            }
            var var5;
            if (input[2] <= 4750.0) {
                var5 = [1.0, 0.0, 0.0];
            } else {
                if (input[5] <= 36.0) {
                    var5 = [0.0, 0.0, 1.0];
                } else {
                    var5 = [0.0, 1.0, 0.0];
                }
            }
            var var6;
            if (input[5] <= 71.0) {
                if (input[5] <= 33.5) {
                    var6 = [0.0, 0.0, 1.0];
                } else {
                    var6 = [0.0, 1.0, 0.0];
                }
            } else {
                var6 = [1.0, 0.0, 0.0];
            }
            var var7;
            if (input[0] <= 77.5) {
                if (input[3] <= 55.0) {
                    var7 = [0.0, 0.0, 1.0];
                } else {
                    var7 = [1.0, 0.0, 0.0];
                }
            } else {
                var7 = [0.0, 1.0, 0.0];
            }
            var var8;
            if (input[2] <= 7000.0) {
                if (input[5] <= 70.0) {
                    var8 = [0.0, 1.0, 0.0];
                } else {
                    var8 = [1.0, 0.0, 0.0];
                }
            } else {
                var8 = [0.0, 0.0, 1.0];
            }
            var var9;
            if (input[6] <= 5.799999952316284) {
                var9 = [0.0, 0.0, 1.0];
            } else {
                if (input[5] <= 75.0) {
                    var9 = [0.0, 1.0, 0.0];
                } else {
                    var9 = [1.0, 0.0, 0.0];
                }
            }
            return mulVectorNumber(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(var0, var1), var2), var3), var4), var5), var6), var7), var8), var9), 0.1);
        }
        function addVectors(v1, v2) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] + v2[i];
            }
            return result;
        }
        function mulVectorNumber(v1, num) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] * num;
            }
            return result;
        }
        // ------------------------------------------------------------------------

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        // ------------------------------------------------------------------------
        async function fetchAndAnalyze() {
            document.getElementById("result").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
            document.getElementById("sensor-display").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...";

            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSV_URL
                const response = await fetch(CSV_URL); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // ‡πÅ‡∏õ‡∏•‡∏á CSV ‡πÄ‡∏õ‡πá‡∏ô Array of Rows
                const rows = csvText.trim().split('\n');
                
                // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏•‡∏∞ Header ***
                let latestRow = rows[rows.length - 1]; // ‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                let values = latestRow.split(',');

                // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (index 0) ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô Timestamp, Header, ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
                // ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2 ‡πÅ‡∏ñ‡∏ß: Header + Data)
                // ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                if (isNaN(parseFloat(values[1])) && rows.length > 2) { 
                    latestRow = rows[rows.length - 2]; 
                    values = latestRow.split(',');
                }

                // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö AI (‡πÉ‡∏ä‡πâ Index ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) ***
                // AI Input Order: Hum_Soil(0), Hum_Air(1), Light(2), N(3), P(4), K(5), pH(6), Temp_Soil(7), Temp_Air(8)
                const currentData = [
                    parseFloat(values[4]),  // 0. Soil% (Hum_Soil) -> Index [4]
                    parseFloat(values[2]),  // 1. AirHum (Hum_Air) -> Index [2]
                    parseFloat(values[6]),  // 2. Light -> Index [6]
                    parseFloat(values[8]),  // 3. N -> Index [8]
                    parseFloat(values[9]),  // 4. P -> Index [9]
                    parseFloat(values[10]), // 5. K -> Index [10]
                    parseFloat(values[7]),  // 6. pH -> Index [7]
                    parseFloat(values[3]),  // 7. SoilTemp -> Index [3]
                    parseFloat(values[1])   // 8. AirTemp -> Index [1]
                ];

                // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ NaN ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ AI ---
                if (currentData.some(isNaN)) {
                     // ‡∏´‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô NaN ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÜ
                     document.getElementById("sensor-display").innerHTML = `
                         <strong>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ NaN! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠: <br> ${latestRow}
                         <br>
                         <strong>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> <br>
                         1. ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Google Sheet<br>
                         2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Soil% (4), AirHum (2), Light (6), N (8), P (9), K (10), pH (7), SoilTemp (3), AirTemp (1) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                     `;
                     document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Sheet ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç";
                     return; 
                }
                
                // --- ‡πÉ‡∏´‡πâ AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ---
                let probabilities = score(currentData);
                
                // ‡∏´‡∏≤‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                let maxIndex = probabilities.indexOf(Math.max(...probabilities));
                let resultCrop = cropNames[maxIndex]; 

                // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
                
                // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ Sensor ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                document.getElementById("sensor-display").innerHTML = `
                    <div class="data-item"><strong>NPK:</strong> ${currentData[3]}-${currentData[4]}-${currentData[5]} | <strong>pH:</strong> ${currentData[6]}</div>
                    <div class="data-item"><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[0]}% / ${currentData[1]}%</div>
                    <div class="data-item"><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[7]}¬∞C / ${currentData[8]}¬∞C | <strong>‡πÅ‡∏™‡∏á:</strong> ${currentData[2]} LUX</div>
                `;

                // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
                document.getElementById("result").innerText = "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö: " + resultCrop;
                
            } catch (error) {
                console.error("Error fetching or processing data:", error);
                document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSV URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish to web)";
            }
        }
    </script>
</body>
</html>
