<!DOCTYPE html>
<html>
<head>
    <title>AI Smart Soil Analysis</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        .box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        h2 { color: #2e7d32; }
        #result { font-weight: bold; font-size: 1.2em; color: #d32f2f; margin-top: 10px;}
        button { background: #2e7d32; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; border-radius: 5px;}
        button:hover { background: #1b5e20; }
        .data-item { margin-bottom: 5px; }
    </style>
</head>
<body onload="fetchAndAnalyze()"> 
    
    <div class="box">
        <h2>üå± AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å IoT...</p>
        
        <div id="sensor-display">
            ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <br>
        <button onclick="fetchAndAnalyze()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
        
        <p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</p>
        <div id="result">-</div>
    </div>

    <script>
        // *** 1. ‡πÉ‡∏™‡πà CSV URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà Google Sheet ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ' ' ‡∏•‡πâ‡∏≠‡∏°‡∏£‡∏≠‡∏ö) ***
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSLIE-xwPr0kFUfTKWatQMG6YXAswXoXnXn5jtS9A9T1XlZPMRHhxjok2BkTQAWbX2CuvNhrW9Yimn/pub?output=csv';

        // 2. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏à‡∏≤‡∏Å Colab: ['Durian' 'Rice' 'Rubber'])
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 0: Durian, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1: Rice, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2: Rubber
        const cropNames = ['Durian', 'Rice', 'Rubber'];

        // ------------------------------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Python ‡πÇ‡∏î‡∏¢ m2cgen)
        // ------------------------------------------------------------------------
        function score(input) {
            var var0;
            if (input[3] <= 92.5) {
                if (input[5] <= 36.0) {
                    var0 = [0.0, 0.0, 1.0];
                } else {
                    var0 = [0.0, 1.0, 0.0];
                }
            } else {
                var0 = [1.0, 0.0, 0.0];
            }
            var var1;
            if (input[7] <= 25.5) {
                var1 = [0.0, 1.0, 0.0];
            } else {
                if (input[2] <= 6000.0) {
                    var1 = [1.0, 0.0, 0.0];
                } else {
                    var1 = [0.0, 0.0, 1.0];
                }
            }
            var var2;
            if (input[7] <= 26.0) {
                var2 = [0.0, 1.0, 0.0];
            } else {
                if (input[3] <= 55.0) {
                    var2 = [0.0, 0.0, 1.0];
                } else {
                    var2 = [1.0, 0.0, 0.0];
                }
            }
            var var3;
            if (input[5] <= 35.0) {
                var3 = [0.0, 0.0, 1.0];
            } else {
                if (input[8] <= 31.0) {
                    var3 = [0.0, 1.0, 0.0];
                } else {
                    var3 = [1.0, 0.0, 0.0];
                }
            }
            var var4;
            if (input[8] <= 31.5) {
                var4 = [0.0, 1.0, 0.0];
            } else {
                if (input[8] <= 34.0) {
                    var4 = [1.0, 0.0, 0.0];
                } else {
                    var4 = [0.0, 0.0, 1.0];
                }
            }
            var var5;
            if (input[2] <= 4750.0) {
                var5 = [1.0, 0.0, 0.0];
            } else {
                if (input[5] <= 36.0) {
                    var5 = [0.0, 0.0, 1.0];
                } else {
                    var5 = [0.0, 1.0, 0.0];
                }
            }
            var var6;
            if (input[5] <= 71.0) {
                if (input[5] <= 33.5) {
                    var6 = [0.0, 0.0, 1.0];
                } else {
                    var6 = [0.0, 1.0, 0.0];
                }
            } else {
                var6 = [1.0, 0.0, 0.0];
            }
            var var7;
            if (input[0] <= 77.5) {
                if (input[3] <= 55.0) {
                    var7 = [0.0, 0.0, 1.0];
                } else {
                    var7 = [1.0, 0.0, 0.0];
                }
            } else {
                var7 = [0.0, 1.0, 0.0];
            }
            var var8;
            if (input[2] <= 7000.0) {
                if (input[5] <= 70.0) {
                    var8 = [0.0, 1.0, 0.0];
                } else {
                    var8 = [1.0, 0.0, 0.0];
                }
            } else {
                var8 = [0.0, 0.0, 1.0];
            }
            var var9;
            if (input[6] <= 5.799999952316284) {
                var9 = [0.0, 0.0, 1.0];
            } else {
                if (input[5] <= 75.0) {
                    var9 = [0.0, 1.0, 0.0];
                } else {
                    var9 = [1.0, 0.0, 0.0];
                }
            }
            return mulVectorNumber(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(var0, var1), var2), var3), var4), var5), var6), var7), var8), var9), 0.1);
        }
        function addVectors(v1, v2) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] + v2[i];
            }
            return result;
        }
        function mulVectorNumber(v1, num) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] * num;
            }
            return result;
        }

        // ------------------------------------------------------------------------
        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        // ------------------------------------------------------------------------
        async function fetchAndAnalyze() {
        document.getElementById("result").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        document.getElementById("sensor-display").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...";

        try {
            const response = await fetch(CSV_URL); 
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            
            const rows = csvText.trim().split('\n');
            
            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Header ‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á ***
            let latestRow = rows[rows.length - 1]; 
            let values = latestRow.split(',');

            // ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Header
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà AirTemp (Index 1) ‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            if (isNaN(parseFloat(values[1])) && rows.length > 2) { 
                latestRow = rows[rows.length - 2]; 
                values = latestRow.split(',');
            }
            // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ñ‡∏ß ***

            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° Header ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
            // Header ‡πÉ‡∏ô Sheet: Timestamp(0), AirTemp(1), AirHum(2), SoilTemp(3), Soil%(4), SoilStatus(5), Light(6), pH(7), N(8), P(9), K(10)
            // AI Input Order: Hum_Soil(0), Hum_Air(1), Light(2), N(3), P(4), K(5), pH(6), Temp_Soil(7), Temp_Air(8)
            const currentData = [
                parseFloat(values[4]),  // 0. Hum_Soil (Soil%) -> Index [4]
                parseFloat(values[2]),  // 1. Hum_Air (AirHum) -> Index [2]
                parseFloat(values[6]),  // 2. Light -> Index [6]
                parseFloat(values[8]),  // 3. N -> Index [8]
                parseFloat(values[9]),  // 4. P -> Index [9]
                parseFloat(values[10]), // 5. K -> Index [10]
                parseFloat(values[7]),  // 6. pH -> Index [7]
                parseFloat(values[3]),  // 7. Temp_Soil (SoilTemp) -> Index [3]
                parseFloat(values[1])   // 8. Temp_Air (AirTemp) -> Index [1]
            ];

            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ NaN/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            if (currentData.some(isNaN)) {
                 // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô NaN ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Sheet ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÜ
                 document.getElementById("sensor-display").innerHTML = `
                     <strong>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ NaN! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠: <br> ${latestRow}
                     <br>
                     <strong>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> <br>
                     1. ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Google Sheet<br>
                     2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á (1, 2, 3, 4, 6, 7, 8, 9, 10) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                 `;
                 document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Sheet ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç";
                 return; 
            }
            
            // --- ‡πÉ‡∏´‡πâ AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ---
            let probabilities = score(currentData);
            
            let maxIndex = probabilities.indexOf(Math.max(...probabilities));
            let resultCrop = cropNames[maxIndex]; 

            // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
            
            // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ Sensor ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById("sensor-display").innerHTML = `
                <div class="data-item"><strong>NPK:</strong> ${currentData[3]}-${currentData[4]}-${currentData[5]} | <strong>pH:</strong> ${currentData[6]}</div>
                <div class="data-item"><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[0]}% / ${currentData[1]}%</div>
                <div class="data-item"><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[7]}¬∞C / ${currentData[8]}¬∞C | <strong>‡πÅ‡∏™‡∏á:</strong> ${currentData[2]} LUX</div>
            `;

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
            document.getElementById("result").innerText = "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö: " + resultCrop;
            
        } catch (error) {
            console.error("Error fetching or processing data:", error);
            document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSV URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish to web)";
        }
    }
</script>
</body>
</html>
