<!DOCTYPE html>
<html>
<head>
    <title>AI Smart Soil Analysis</title>
    <style>
        /* ... (CSS Styles ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°) ... */
    </style>
</head>
<body onload="fetchAndAnalyze()"> 
    
    <div class="box">
        <h2>üå± AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å IoT...</p>
        
        <div id="sensor-display">
            ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <br>
        <button onclick="fetchAndAnalyze()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
        
        <p>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</p>
        <div id="result">-</div>
    </div>

    <script>
        // 1. ‡πÉ‡∏™‡πà CSV URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà Google Sheet ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSLIE-xwPr0kFUfTKWatQMG6YXAswXoXnXn5jtS9A9T1XlZPMRHhxjok2BkTQAWbX2CuvNhrW9Yimn/pub?output=csv';

        // 2. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏à‡∏≤‡∏Å Colab)
        const cropNames = ['Durian', 'Rice', 'Rubber'];

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÇ‡∏Ñ‡πâ‡∏î score, addVectors, mulVectorNumber ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°)
        // ------------------------------------------------------------------------
        function score(input) {
            var var0;
            if (input[3] <= 92.5) {
                if (input[5] <= 36.0) {
                    var0 = [0.0, 0.0, 1.0];
                } else {
                    var0 = [0.0, 1.0, 0.0];
                }
            } else {
                var0 = [1.0, 0.0, 0.0];
            }
            var var1;
            if (input[7] <= 25.5) {
                var1 = [0.0, 1.0, 0.0];
            } else {
                if (input[2] <= 6000.0) {
                    var1 = [1.0, 0.0, 0.0];
                } else {
                    var1 = [0.0, 0.0, 1.0];
                }
            }
            var var2;
            if (input[7] <= 26.0) {
                var2 = [0.0, 1.0, 0.0];
            } else {
                if (input[3] <= 55.0) {
                    var2 = [0.0, 0.0, 1.0];
                } else {
                    var2 = [1.0, 0.0, 0.0];
                }
            }
            var var3;
            if (input[5] <= 35.0) {
                var3 = [0.0, 0.0, 1.0];
            } else {
                if (input[8] <= 31.0) {
                    var3 = [0.0, 1.0, 0.0];
                } else {
                    var3 = [1.0, 0.0, 0.0];
                }
            }
            var var4;
            if (input[8] <= 31.5) {
                var4 = [0.0, 1.0, 0.0];
            } else {
                if (input[8] <= 34.0) {
                    var4 = [1.0, 0.0, 0.0];
                } else {
                    var4 = [0.0, 0.0, 1.0];
                }
            }
            var var5;
            if (input[2] <= 4750.0) {
                var5 = [1.0, 0.0, 0.0];
            } else {
                if (input[5] <= 36.0) {
                    var5 = [0.0, 0.0, 1.0];
                } else {
                    var5 = [0.0, 1.0, 0.0];
                }
            }
            var var6;
            if (input[5] <= 71.0) {
                if (input[5] <= 33.5) {
                    var6 = [0.0, 0.0, 1.0];
                } else {
                    var6 = [0.0, 1.0, 0.0];
                }
            } else {
                var6 = [1.0, 0.0, 0.0];
            }
            var var7;
            if (input[0] <= 77.5) {
                if (input[3] <= 55.0) {
                    var7 = [0.0, 0.0, 1.0];
                } else {
                    var7 = [1.0, 0.0, 0.0];
                }
            } else {
                var7 = [0.0, 1.0, 0.0];
            }
            var var8;
            if (input[2] <= 7000.0) {
                if (input[5] <= 70.0) {
                    var8 = [0.0, 1.0, 0.0];
                } else {
                    var8 = [1.0, 0.0, 0.0];
                }
            } else {
                var8 = [0.0, 0.0, 1.0];
            }
            var var9;
            if (input[6] <= 5.799999952316284) {
                var9 = [0.0, 0.0, 1.0];
            } else {
                if (input[5] <= 75.0) {
                    var9 = [0.0, 1.0, 0.0];
                } else {
                    var9 = [1.0, 0.0, 0.0];
                }
            }
            return mulVectorNumber(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(addVectors(var0, var1), var2), var3), var4), var5), var6), var7), var8), var9), 0.1);
        }
        function addVectors(v1, v2) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] + v2[i];
            }
            return result;
        }
        function mulVectorNumber(v1, num) {
            var result = new Array(v1.length);
            for (var i = 0; i < v1.length; i++) {
                result[i] = v1[i] * num;
            }
            return result;
        }
        // ------------------------------------------------------------------------

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        // ------------------------------------------------------------------------
       async function fetchAndAnalyze() {
        document.getElementById("result").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        document.getElementById("sensor-display").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...";

        try {
            const response = await fetch(CSV_URL); 
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            
            const rows = csvText.trim().split('\n');
            
            // 1. ‡∏î‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢)
            let latestRow = rows[rows.length - 1]; 
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Header ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            if (latestRow.split(',').length < 10 && rows.length > 2) { 
                latestRow = rows[rows.length - 2]; 
            }
            let values = latestRow.split(',');

            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 12 ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ***
            // Timestamp ‡∏°‡∏µ Comma ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (Index 0, 1) ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Index ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            // Header ‡πÉ‡∏ô Sheet: Timestamp(0,1), AirTemp(2), AirHum(3), SoilTemp(4), Soil%(5), SoilStatus(6), Light(7), pH(8), N(9), P(10), K(11)
            // AI Input Order: Hum_Soil(0), Hum_Air(1), Light(2), N(3), P(4), K(5), pH(6), Temp_Soil(7), Temp_Air(8)
            const currentData = [
                parseFloat(values[5]),  // 0. Hum_Soil (Soil%) -> Index [5]
                parseFloat(values[3]),  // 1. Hum_Air (AirHum) -> Index [3]
                parseFloat(values[7]),  // 2. Light -> Index [7]
                parseFloat(values[9]),  // 3. N -> Index [9]
                parseFloat(values[10]), // 4. P -> Index [10]
                parseFloat(values[11]), // 5. K -> Index [11]
                parseFloat(values[8]),  // 6. pH -> Index [8]
                parseFloat(values[4]),  // 7. Temp_Soil (SoilTemp) -> Index [4]
                parseFloat(values[2])   // 8. Temp_Air (AirTemp) -> Index [2]
            ];

            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ NaN/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ú‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á) ---
            if (currentData.some(isNaN)) {
                 document.getElementById("sensor-display").innerHTML = `
                     <strong>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ NaN! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠: <br> ${latestRow}
                     <br>
                     <strong>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> <br>
                     - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Timestamp ‡πÅ‡∏•‡∏∞ SoilStatus)
                 `;
                 document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Sheet ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç";
                 return; 
            }
            
            // --- ‡πÉ‡∏´‡πâ AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß) ---
            let probabilities = score(currentData);
            
            let maxIndex = probabilities.indexOf(Math.max(...probabilities));
            let resultCrop = cropNames[maxIndex]; 

            document.getElementById("sensor-display").innerHTML = `
                <div class="data-item"><strong>NPK:</strong> ${currentData[3]}-${currentData[4]}-${currentData[5]} | <strong>pH:</strong> ${currentData[6]}</div>
                <div class="data-item"><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[0]}% / ${currentData[1]}%</div>
                <div class="data-item"><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏î‡∏¥‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> ${currentData[7]}¬∞C / ${currentData[8]}¬∞C | <strong>‡πÅ‡∏™‡∏á:</strong> ${currentData[2]} LUX</div>
            `;

            document.getElementById("result").innerText = "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö: " + resultCrop;
            
        } catch (error) {
            console.error("Error fetching or processing data:", error);
            document.getElementById("result").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CSV URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish to web)";
        }
    }
</script>
</body>
</html>
